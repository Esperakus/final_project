global
        maxconn 100
        log     127.0.0.1 local2

defaults
        log global
        mode http
        retries 2
        timeout client 30m
        timeout connect 4s
        timeout server 30m
        timeout check 5s
        balance roundrobin

listen stats
    mode http
    bind *:7000
    stats enable
    stats uri /

frontend web
    bind *:80
    acl grafana path -i -m beg /grafana
    use_backend grafana if grafana
    default_backend web

listen postgres
    bind *:5432
    mode tcp
    option httpchk
    http-check expect status 200
    default-server inter 1s fall 3 rise 2 on-marked-down shutdown-sessions
    {% for host in groups['db_hosts'] %}
    server {{ hostvars[host]['inventory_hostname'] }} {{ hostvars[host]['inventory_hostname'] }}:5432 maxconn 100 check port 8008
    {% endfor %}

backend grafana
    option httpchk
    default-server inter 3s fall 3 rise 2
    {% for host in groups['grafana'] %}
    server {{ hostvars[host]['inventory_hostname'] }} {{ hostvars[host]['inventory_hostname'] }}:3000 maxconn 100 check
    {% endfor %}

backend web
    option httpchk
    http-check expect status 200
    default-server inter 1s fall 3 rise 2
    {% for host in groups['backend_hosts'] %}
    server {{ hostvars[host]['inventory_hostname'] }} {{ hostvars[host]['inventory_hostname'] }}:8090 maxconn 100 check
    {% endfor %}

